<!DOCTYPE html>
<html lang="de" class="game-html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EvoCraft - Spielen</title>
    <link rel="stylesheet" href="../website/website.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="../website/assets/icons/logo.png">
    
    <style>
        /* Game Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f0f23, #1a1a2e);
            color: #ffffff;
            overflow: hidden;
            height: 100vh;
        }

        /* Ladebildschirm */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f0f23, #1a1a2e);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-logo {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 2rem;
            background: linear-gradient(45deg, #3b82f6, #22c55e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: glow 2s ease-in-out infinite alternate;
        }

        .loading-progress {
            width: 300px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .loading-bar {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #22c55e);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        .loading-text {
            color: #94a3b8;
            font-size: 0.9rem;
            text-align: center;
        }

        /* Hauptspiel */
        .game-container {
            display: none;
            height: 100vh;
            grid-template-columns: 250px 1fr;
            background: linear-gradient(135deg, #0f0f23, #1a1a2e);
        }

        /* Sidebar */
        .sidebar {
            background: rgba(30, 30, 60, 0.8);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar h3 {
            color: #3b82f6;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .elements-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 2rem;
        }

        .element {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: grab;
            transition: all 0.3s ease;
            user-select: none;
        }

        .element:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .element img {
            width: 32px;
            height: 32px;
            margin-bottom: 5px;
            object-fit: contain;
        }

        .element-name {
            font-size: 0.8rem;
            color: #e2e8f0;
        }

        .element.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        /* Inventar */
        .inventory {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 8px;
            padding: 15px;
        }

        .inventory-count {
            font-size: 0.9rem;
            color: #22c55e;
            text-align: center;
            margin-bottom: 10px;
        }

        .inventory-items {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .inventory-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            font-size: 0.7rem;
        }

        .inventory-item img {
            width: 20px;
            height: 20px;
            margin-bottom: 3px;
        }

        /* Crafting Area */
        .crafting-area {
            position: relative;
            background: transparent;
            overflow: hidden;
        }

        .crafting-canvas {
            width: 100%;
            height: 100vh;
            position: relative;
            background: 
                radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(34, 197, 94, 0.1) 0%, transparent 50%);
        }

        /* Kombinationszonen */
        .combine-zone {
            position: absolute;
            width: 120px;
            height: 120px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .combine-zone.left {
            transform: translate(-150px, -50%);
        }

        .combine-zone.right {
            transform: translate(50px, -50%);
        }

        .combine-zone.active {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }

        .zone-hint {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
            text-align: center;
        }

        /* Platzierte Elemente */
        .placed-element {
            position: absolute;
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #3b82f6;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: move;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .placed-element img {
            width: 40px;
            height: 40px;
            margin-bottom: 5px;
        }

        .placed-element-name {
            font-size: 0.7rem;
            color: #e2e8f0;
            text-align: center;
        }

        /* Kombinationseffekt */
        .combination-effect {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(34, 197, 94, 0.6), transparent);
            animation: combine-pulse 1s ease-out;
            pointer-events: none;
            z-index: 200;
        }

        /* Neues Element Animation */
        .new-element {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(34, 197, 94, 0.2);
            border: 2px solid #22c55e;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            animation: element-appear 2s ease-out forwards;
            z-index: 300;
            backdrop-filter: blur(10px);
        }

        .new-element img {
            width: 60px;
            height: 60px;
            margin-bottom: 10px;
        }

        .new-element-name {
            color: #22c55e;
            font-weight: 600;
            text-align: center;
        }

        .new-badge {
            background: #22c55e;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.7rem;
            margin-top: 8px;
        }

        /* Animationen */
        @keyframes glow {
            from { text-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
            to { text-shadow: 0 0 30px rgba(34, 197, 94, 0.5); }
        }

        @keyframes combine-pulse {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
        }

        @keyframes element-appear {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .game-container {
                grid-template-columns: 1fr;
                grid-template-rows: 150px 1fr;
            }
            
            .sidebar {
                padding: 10px;
                overflow-x: auto;
            }
            
            .elements-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Ladebildschirm -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">EvoCraft</div>
        <div class="loading-progress">
            <div class="loading-bar" id="loadingBar"></div>
        </div>
        <div class="loading-text" id="loadingText">Spiel wird initialisiert...</div>
    </div>

    <!-- Hauptspiel -->
    <div class="game-container" id="gameContainer">
        <!-- Sidebar mit Elementen -->
        <div class="sidebar">
            <h3>Verfügbare Elemente</h3>
            <div class="elements-grid" id="elementsGrid">
                <!-- Startelemente -->
                <div class="element" data-element="stone" draggable="true">
                    <img src="assets/sprites/stone.png" alt="Stein">
                    <div class="element-name">Stein</div>
                </div>
                <div class="element" data-element="wood" draggable="true">
                    <img src="assets/sprites/wood.png" alt="Holz">
                    <div class="element-name">Holz</div>
                </div>
            </div>

            <h3>Inventar</h3>
            <div class="inventory">
                <div class="inventory-count" id="inventoryCount">0 Elemente entdeckt</div>
                <div class="inventory-items" id="inventoryItems">
                    <!-- Dynamisch gefüllt -->
                </div>
            </div>
        </div>

        <!-- Crafting Area -->
        <div class="crafting-area">
            <canvas class="crafting-canvas" id="craftingCanvas"></canvas>
            
            <!-- Kombinationszonen -->
            <div class="combine-zone left" id="combineZone1">
                <div class="zone-hint">Element hier<br>hinziehen</div>
            </div>
            
            <div class="combine-zone right" id="combineZone2">
                <div class="zone-hint">Element hier<br>hinziehen</div>
            </div>
        </div>
    </div>

    <script>
        // Globale Variablen
        let craftingLogic = {};
        let discoveredElements = new Set(['stone', 'wood']);
        let inventory = new Map();
        let draggedElement = null;
        let placedElements = [];

        // Element-Daten
        const elementData = {
            stone: { name: 'Stein', german: 'Stein' },
            wood: { name: 'Holz', german: 'Holz' },
            spark: { name: 'Funken', german: 'Funken' },
            fire: { name: 'Feuer', german: 'Feuer' },
            fireplace: { name: 'Feuerstelle', german: 'Feuerstelle' },
            seed: { name: 'Samen', german: 'Samen' },
            water: { name: 'Wasser', german: 'Wasser' },
            sapling: { name: 'Setzling', german: 'Setzling' },
            earth: { name: 'Erde', german: 'Erde' },
            mud: { name: 'Schlamm', german: 'Schlamm' },
            axe: { name: 'Beil', german: 'Beil' }
        };

        // Server-URL (deine Render.com URL hier eintragen)
        const SERVER_URL = 'https://evocraft-server.onrender.com'; // HIER DEINE URL EINTRAGEN
        const SECRET_TOKEN = 'evocraft-secure-123';

        // Spiel initialisieren
        async function initializeGame() {
            const loadingBar = document.getElementById('loadingBar');
            const loadingText = document.getElementById('loadingText');

            try {
                // Schritt 1: Verbindung zum Server
                loadingText.textContent = 'Verbinde mit Server...';
                loadingBar.style.width = '20%';
                await new Promise(resolve => setTimeout(resolve, 500));

                // Schritt 2: Match-Logik laden
                loadingText.textContent = 'Lade Crafting-Regeln...';
                loadingBar.style.width = '40%';
                
                const response = await fetch(`${SERVER_URL}/match-logic`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${SECRET_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Server-Fehler: ${response.status}`);
                }

                craftingLogic = await response.json();
                console.log('✅ Crafting-Logik geladen:', Object.keys(craftingLogic).length, 'Regeln');

                // Schritt 3: Spielelemente vorbereiten
                loadingText.textContent = 'Bereite Spielelemente vor...';
                loadingBar.style.width = '70%';
                await new Promise(resolve => setTimeout(resolve, 300));

                // Schritt 4: UI initialisieren
                loadingText.textContent = 'Starte Spiel...';
                loadingBar.style.width = '100%';
                await new Promise(resolve => setTimeout(resolve, 500));

                // Spiel starten
                startGame();

            } catch (error) {
                console.error('❌ Fehler beim Laden:', error);
                loadingText.textContent = 'Fehler beim Laden. Versuche es erneut...';
                loadingText.style.color = '#ef4444';
                
                // Fallback nach 3 Sekunden
                setTimeout(() => {
                    craftingLogic = {
                        "Stein+Stein": "Funken",
                        "Funken+Holz": "Feuer", 
                        "Feuer+Stein": "Feuerstelle"
                    };
                    startGame();
                }, 3000);
            }
        }

        // Spiel starten
        function startGame() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'grid';
            
            setupDragAndDrop();
            updateInventory();
            console.log('🎮 Spiel gestartet!');
        }

        // Drag & Drop Setup
        function setupDragAndDrop() {
            const elements = document.querySelectorAll('.element');
            const zones = document.querySelectorAll('.combine-zone');
            const craftingCanvas = document.getElementById('craftingCanvas');

            // Element Drag Events
            elements.forEach(element => {
                element.addEventListener('dragstart', (e) => {
                    draggedElement = e.target.dataset.element;
                    e.target.classList.add('dragging');
                });

                element.addEventListener('dragend', (e) => {
                    e.target.classList.remove('dragging');
                    draggedElement = null;
                });
            });

            // Canvas Drop Events
            craftingCanvas.addEventListener('dragover', (e) => {
                e.preventDefault();
            });

            craftingCanvas.addEventListener('drop', (e) => {
                e.preventDefault();
                if (!draggedElement) return;

                const rect = craftingCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                placeElementOnCanvas(draggedElement, x, y);
            });

            // Zone Drop Events
            zones.forEach(zone => {
                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    zone.classList.add('active');
                });

                zone.addEventListener('dragleave', () => {
                    zone.classList.remove('active');
                });

                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    zone.classList.remove('active');
                    
                    if (!draggedElement) return;
                    placeElementInZone(draggedElement, zone);
                });
            });
        }

        // Element auf Canvas platzieren
        function placeElementOnCanvas(elementType, x, y) {
            const craftingArea = document.querySelector('.crafting-area');
            const element = document.createElement('div');
            element.className = 'placed-element';
            element.dataset.element = elementType;
            element.style.left = (x - 40) + 'px';
            element.style.top = (y - 40) + 'px';
            
            const elementInfo = elementData[elementType];
            element.innerHTML = `
                <img src="assets/sprites/${elementType}.png" alt="${elementInfo.german}">
                <div class="placed-element-name">${elementInfo.german}</div>
            `;

            craftingArea.appendChild(element);
            placedElements.push({ element, type: elementType, x: x - 40, y: y - 40 });

            // Element draggable machen
            makeElementDraggable(element);
            
            // Kollisionsprüfung
            checkCollisions();
        }

        // Element in Zone platzieren
        function placeElementInZone(elementType, zone) {
            const elementInfo = elementData[elementType];
            zone.innerHTML = `
                <img src="assets/sprites/${elementType}.png" alt="${elementInfo.german}" style="width: 50px; height: 50px;">
                <div style="color: #3b82f6; font-weight: 600; margin-top: 5px;">${elementInfo.german}</div>
            `;
            zone.dataset.element = elementType;
            
            // Prüfe Kombination
            checkZoneCombination();
        }

        // Platziertes Element draggable machen
        function makeElementDraggable(element) {
            let isDragging = false;
            let startX, startY, elementX, elementY;

            element.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                elementX = parseInt(element.style.left);
                elementY = parseInt(element.style.top);
                element.style.zIndex = '1000';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                
                element.style.left = (elementX + deltaX) + 'px';
                element.style.top = (elementY + deltaY) + 'px';
                
                // Update Position für Kollisionsprüfung
                const placedElement = placedElements.find(pe => pe.element === element);
                if (placedElement) {
                    placedElement.x = elementX + deltaX;
                    placedElement.y = elementY + deltaY;
                }
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    element.style.zIndex = '100';
                    checkCollisions();
                }
            });
        }

        // Kollisionsprüfung
        function checkCollisions() {
            for (let i = 0; i < placedElements.length; i++) {
                for (let j = i + 1; j < placedElements.length; j++) {
                    const el1 = placedElements[i];
                    const el2 = placedElements[j];
                    
                    const distance = Math.sqrt(
                        Math.pow(el1.x - el2.x, 2) + Math.pow(el1.y - el2.y, 2)
                    );
                    
                    if (distance < 80) { // Kollision erkannt
                        combineElements(el1.type, el2.type, el1, el2);
                        return;
                    }
                }
            }
        }

        // Zonenkombination prüfen
        function checkZoneCombination() {
            const zone1 = document.getElementById('combineZone1');
            const zone2 = document.getElementById('combineZone2');
            
            if (zone1.dataset.element && zone2.dataset.element) {
                setTimeout(() => {
                    combineElements(zone1.dataset.element, zone2.dataset.element);
                    
                    // Zonen zurücksetzen
                    zone1.innerHTML = '<div class="zone-hint">Element hier<br>hinziehen</div>';
                    zone2.innerHTML = '<div class="zone-hint">Element hier<br>hinziehen</div>';
                    delete zone1.dataset.element;
                    delete zone2.dataset.element;
                }, 500);
            }
        }

        // Elemente kombinieren
        function combineElements(type1, type2, el1 = null, el2 = null) {
            const key1 = `${elementData[type1].german}+${elementData[type2].german}`;
            const key2 = `${elementData[type2].german}+${elementData[type1].german}`;
            
            const result = craftingLogic[key1] || craftingLogic[key2];
            
            if (result) {
                // Kombinationseffekt anzeigen
                showCombinationEffect();
                
                // Elemente entfernen
                if (el1 && el2) {
                    el1.element.remove();
                    el2.element.remove();
                    placedElements = placedElements.filter(pe => pe !== el1 && pe !== el2);
                }
                
                // Neues Element erstellen
                setTimeout(() => {
                    const newElementType = getElementKeyByGerman(result);
                    if (newElementType) {
                        showNewElement(newElementType);
                        addToInventory(newElementType);
                        unlockElement(newElementType);
                    }
                }, 500);
            }
        }

        // Deutschen Namen zu Element-Key konvertieren
        function getElementKeyByGerman(germanName) {
            for (const [key, data] of Object.entries(elementData)) {
                if (data.german === germanName) {
                    return key;
                }
            }
            return null;
        }

        // Kombinationseffekt zeigen
        function showCombinationEffect() {
            const effect = document.createElement('div');
            effect.className = 'combination-effect';
            document.querySelector('.crafting-area').appendChild(effect);
            
            setTimeout(() => effect.remove(), 1000);
        }

        // Neues Element anzeigen
        function showNewElement(elementType) {
            const elementInfo = elementData[elementType];
            const newElement = document.createElement('div');
            newElement.className = 'new-element';
            newElement.innerHTML = `
                <img src="assets/sprites/${elementType}.png" alt="${elementInfo.german}">
                <div class="new-element-name">${elementInfo.german}</div>
                <div class="new-badge">Neu entdeckt!</div>
            `;
            
            document.querySelector('.crafting-area').appendChild(newElement);
            
            setTimeout(() => newElement.remove(), 3000);
        }

        // Element freischalten
        function unlockElement(elementType) {
            if (!discoveredElements.has(elementType)) {
                discoveredElements.add(elementType);
                
                const elementsGrid = document.getElementById('elementsGrid');
                const elementInfo = elementData[elementType];
                
                const elementDiv = document.createElement('div');
                elementDiv.className = 'element';
                elementDiv.dataset.element = elementType;
                elementDiv.draggable = true;
                elementDiv.innerHTML = `
                    <img src="assets/sprites/${elementType}.png" alt="${elementInfo.german}">
                    <div class="element-name">${elementInfo.german}</div>
                `;
                
                elementsGrid.appendChild(elementDiv);
                
                // Drag Events hinzufügen
                elementDiv.addEventListener('dragstart', (e) => {
                    draggedElement = e.target.dataset.element;
                    e.target.classList.add('dragging');
                });

                elementDiv.addEventListener('dragend', (e) => {
                    e.target.classList.remove('dragging');
                    draggedElement = null;
                });
            }
        }

        // Inventar hinzufügen
        function addToInventory(elementType) {
            const current = inventory.get(elementType) || 0;
            inventory.set(elementType, current + 1);
            updateInventory();
        }

        // Inventar aktualisieren
        function updateInventory() {
            const inventoryCount = document.getElementById('inventoryCount');
            const inventoryItems = document.getElementById('inventoryItems');
            
            inventoryCount.textContent = `${discoveredElements.size} Elemente entdeckt`;
            
            let html = '';
            for (const [elementType, count] of inventory) {
                const elementInfo = elementData[elementType];
                html += `
                    <div class="inventory-item">
                        <img src="assets/sprites/${elementType}.png" alt="${elementInfo.german}">
                        <div>${elementInfo.german}</div>
                        <div style="color: #22c55e; font-weight: 600;">${count}x</div>
                    </div>
                `;
            }
            
            inventoryItems.innerHTML = html || '<div style="color: #64748b; text-align: center; padding: 20px;">Noch keine Elemente gecraftet</div>';
        }

        // Spiel beim Laden starten
        window.addEventListener('DOMContentLoaded', initializeGame);
    </script>
</body>
</html>
